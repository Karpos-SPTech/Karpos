<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <link rel="shortcut icon" href="../sidebar/src/images/logo-contato.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style-dashboard.css">
    <link rel="shortcut icon" href="assets/logo-contato.png" type="image/x-icon">
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
    <title>Karpos</title>
</head>

<body>
    <nav id="sidebar">
        <div id="sidebar_content">
            <div id="user">
                <img src="assets/logo-contato.png" id="user_avatar" alt="Avatar">

                <p id="user_infos">
                    <span class="item-description">
                        Karpos Dash
                    </span>
                    <span class="item-description">
                        Bem vindo
                    </span>
                </p>
            </div>

            <ul id="side_items">
                <li class="side-item active" id="btnAreaUsuario"
                    onclick="scrollToSection('section_areaDoUsuario', 'Geral')">
                    <a href="#">
                        <i class="fa-solid fa-user"></i>
                        <span class="item-description">
                            Área do usuário
                        </span>
                    </a>

                </li>

                <li class="side-item" id="btnAreaDashboard">
                    <a href="#">
                        <i class="fa-solid fa-chart-line"></i>
                        <span class="item-description">
                            Dashboard
                        </span>
                    </a>
                </li>

                <li class="side-item" id="btnAreaTabelas">
                    <a href="#">
                        <i class="fa-solid fa-table"></i>
                        <span class="item-description">
                            Tabelas
                        </span>
                    </a>
                </li>
                <li class="side-item" id="btnAreaAjuda">
                    <a href="#">
                        <i class="fa-solid fa-circle-question"></i>
                        <span class="item-description">
                            Ajuda
                        </span>
                    </a>
                </li>
                <li class="side-item" id="btnSuporte">
                    <a href="https://karpos.atlassian.net/servicedesk/customer/portal/1" target="_blank">
                        <i class="fa-solid fa-headset"></i>
                        <span class="item-description">
                            Suporte
                        </span>
                    </a>
                </li>
            </ul>

            <button id="open_btn">
                <i id="open_btn_icon" class="fa-solid fa-chevron-right"></i>
            </button>
        </div>

        <div id="logout">
            <button id="logout_btn" onclick="exit()">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span class="item-description">
                    Sair
                </span>
            </button>
        </div>
    </nav>
    <main id="main-class" style="height: 100%;">
        <section id="section_dashboard" style="display:none;">
            <h1 class="principal"> MONITORAMENTO DOS ALGODÕES</h1>

            <div class="alertas">
                <div style="display: flex; flex-direction: column; justify-content: flex-end;">
                    <h1 class="titulograf1">Local:</h1>
                    <div class="fazenda">
                        <img width="120px" height="120px" src="assets/fazendaa.png" alt="">
                        Fazenda Karpos
                        <p id="setor">Lote 1</p>
                    </div>
                </div>
                <span style="border: 2px solid rgb(245,222,179, 0.4);"></span>
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <h1 class="titulograf1">Dados Atuais:</h1>
                    <div class="hoje">
                        <div id="tempo"></div>
                        <div id="clima"></div>
                    </div>
                </div>
                <span style="border: 2px solid rgb(245,222,179, 0.4); margin-left: 1%;"></span>
                <div style="display: flex; flex-direction: column; height: 100%; gap: 5%;">
                    <h1 class="titulograf1" style="margin-bottom: 2%;">Parâmetros:</h1>
                        <h3>Umidade:</h3>
                        <div class="parametroU"><span> <49% </span><span><=55% </span><span> 56% a 64% </span><span> >=65% </span><span> >70%</span></div>
                        <h3>Temperatura:</h3>
                        <div class="parametroT"><span> <16ºC </span><span><=20ºC </span><span> 21ºC a 29ºC </span><span> >=30ºC </span><span> >34ºC</span></div>
                </div>
            </div>
            <div class="graficosContainer">
                <div class="grafico-item">
                    <h1 class="titulograf">Análise de Umidade na Plantação</h1>
                    <div class="dois">
                        <div class="graficos">
                            <canvas id="dht11Umidade"></canvas>
                        </div>
                        <div id="gauge">
                            <div class="parametros"><span> 0% </span><span>100%</span></div>
                            <div class="tituloGauge">Umidade Atual (%)</div>
                        </div>
                        <div id="textboxUmi"></div>
                    </div>
                </div>
                <div class="grafico-item1">
                    <h1 class="titulograf">Análise de Temperatura na Plantação</h1>
                    <div class="dois">
                        <div class="graficos">
                            <canvas id="lm35Temperatura"></canvas>
                        </div>
                        <div id="gauge2">
                            <div class="parametros"><span>0ºC</span><span>100ºC</span></div>
                            <div class="tituloGauge">Temperatura Atual (ºC)</div>
                        </div>
                        <div id="textboxTemp"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="section_areaDoUsuario" style="display: block;">
            <h1 style="font-size: 30px;">Área do Usuário</h1>
            <!-- <img class="imgf" src="assets/fazendaa.png" width="150px" alt=""> -->
            <h3 class="mensagem">Fazenda Karpos</h3>
            <h3 style="font-size: 30px;">Lotes:</h3>
            <div class="lotes">
                <div class="boxlote"> <img src="assets/logo-Dashboard.png" width="50px" style="margin-bottom: 5%;"
                        alt="">Lote 1
                    <div class="lotesbox"><i id="iconTemp1" onclick="scrollToSection('section_dashboard', 'Lote 1')"
                            class="fas fa-thermometer-half icon"></i>
                        <i id="iconUmi1" onclick="scrollToSection('section_dashboard', 'Lote 1 ')"
                            class="fas fa-tint icon"></i>
                    </div>
                </div>
                <div class="boxlote"><img src="assets/logo-Dashboard.png" width="50px" style="margin-bottom: 5%;"
                        alt="">
                    <p>Lote 2</p>
                    <div class="lotesbox"><i id="iconTemp2" onclick="scrollToSection('section_dashboard', 'Lote 2')"
                            class="fas fa-thermometer-half icon"></i>
                        <i id="iconUmi2" onclick="scrollToSection('section_dashboard', 'Lote 2 ')"
                            class="fas fa-tint icon"></i>
                    </div>

                </div>
                <div class="boxlote"><img src="assets/logo-Dashboard.png" width="50px" style="margin-bottom: 5%;"
                        alt="">Lote 3
                    <div class="lotesbox"><i id="iconTemp3" onclick="scrollToSection('section_dashboard','Lote 3')"
                            class="fas fa-thermometer-half icon"></i>
                        <i id="iconUmi3" onclick="scrollToSection('section_dashboard','Lote 3 ')"
                            class="fas fa-tint icon"></i>
                    </div>
                </div>
                <div class="boxlote"><img src="assets/logo-Dashboard.png" width="50px" style="margin-bottom: 5%;"
                        alt="">Lote 4
                    <div class="lotesbox"><i id="iconTemp4" onclick="scrollToSection('section_dashboard', 'Lote 4')"
                            class="fas fa-thermometer-half icon"></i>
                        <i id="iconUmi4" onclick="scrollToSection('section_dashboard', 'Lote 4 ')"
                            class="fas fa-tint icon"></i>
                    </div>
                </div>
            </div>
            <div class="titulosFlexBox">
                <h3 class="legendaFazenda" style="font-size: 30px;">Legenda:</h3>
                <h3 class="nossosavisos" style="font-size: 30px;">Avisos:</h3>
            </div>
            <div class="flexBox">
                <div class="legenda">
                    <div class="legendaicones">
                        <i style="color: black;" id="iconTemp" class="fas fa-thermometer-half icon1 tempe">
                            <span class="temp">Temperatura (ºC)</span></i>
                        <i style="color: black;" id="iconUmi" class="fas fa-tint icon1 tempe">
                            <span class="temp">Umidade (%)</span></i>
                    </div>
                    <div class="legendacoresUmidade">
                        <h3 class="tituloLegendas">Umidade:</h3>
                        <div class="branco"> <span class="corb"></span>Entre 56% e 64%</div>
                        <div class="amarelo"><span class="cora"></span>De 49% a 55%</div>
                        <div class="amarelo"><span class="cora"></span>De 65% a 70%</div>
                        <div class="vermelho"><span class="corv"></span>
                            <49% ou >70%
                        </div>
                    </div>
                    <div class="legendacores">
                        <h3 class="tituloLegendas">Temperatura:</h3>
                        <div class="branco"> <span class="corb"></span>Entre 21ºC e 29ºC</div>
                        <div class="amarelo"><span class="cora"></span>De 16ºC a 20ºC</div>
                        <div class="amarelo"><span class="cora"></span>De 30ºC a 34ºC</div>
                        <div class="vermelho"><span class="corv"></span>
                            <16ºC ou >34ºC
                        </div>
                    </div>
                </div>
                <div class="nossos">
                    <div class="cada">
                        <div class="boxbom">
                            <img width="50px"
                                src="./assets/favoravel.png" alt="">
                            <b>FAVORÁVEL</b>
                        </div>
                        <p class="desc">Tudo sob controle, mas continue monitorando para garantir a estabilidade e o
                            crescimento saudável da plantação. </p>
                    </div>
                    <div class="cada">
                        <div class="boxcuidado">
                            <img width="50px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt="">
                            <b>CUIDADO</b>
                        </div>
                        <p class="desc">A temperatura e/ou umidade estão prestes a sair do controle. Monitore de perto e
                            tome medidas preventivas para garantir a saúde dos algodões.</p>
                    </div>

                    <div class="cada">
                        <div class="boxalerta">
                            <img width="50px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt="">
                            <b>ALERTA</b>
                        </div>
                        <p class="desc">A temperatura e/ou umidade estão fora do padrão. Recomendamos ação imediata para
                            evitar possíveis danos à plantação.</p>
                    </div>
                </div>
            </div>
        </section>
        <section id="section_tabelas" style="display: none;">
            <h1>Área das tabelas</h1>
            <h3 style="display: flex; justify-content: center; margin-bottom: 1%; font-size: 20px;">Últimas 15 Leituras</h3>
            <div class="divSelect">
                <select id="intervaloEspecifico">
                    <option value="#">Intervalo de Tempo</option>
                    <option value=5>5 Segundos</option>
                    <option value=10>10 Segundos</option>
                    <option value=15>15 Segundos</option>
                    <option value=30>30 Segundos</option>
                    <option value=60>1 Minuto</option>
                </select>
                <select id="loteEspecifico">
                    <option value="#">Todos os Lotes</option>
                    <option value="1">Lote 1</option>
                    <option value="2">Lote 2</option>
                    <option value="3">Lote 3</option>
                    <option value="4">Lote 4</option>
                </select>
                <span class="btnExport" id="btnAreaExportar" onclick="exportar()">
                    <a href="#" style="text-decoration: none; color: white; font-size: 18px;">
                        <i class="fa-solid fa-file-export"></i>
                        <span class="item-description">
                            Exportar Tabela
                        </span>
                    </a>
                </span>
            </div>
            <table id="dadosTabela">
                <thead>
                    <tr>
                        <th>Data e Hora (Horário de Brasília)</th>
                        <th>Temperatura (°C)</th>
                        <th>Umidade (%)</th>
                        <th>Lote</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aqui serão adicionadas as linhas da tabela dinamicamente -->
                </tbody>
            </table>
        </section>
        <section id="section_ajuda" style="display: none;">
            <h2 class="titulo-ajuda">Área de Ajuda</h2><br>
            <h3 class="titulo-ajuda">Utilize nossa avançada inteligência artificial para obter respostas claras e precisas para todas as suas dúvidas e necessidades.</h3>
            <div id="container-ajuda">
                <center>
                    <h1 style="margin-bottom: 20px;">Karpos IA</h1>
                    <textarea id="pergunta" type="text" placeholder="Digite a sua pergunta..."></textarea>
                    <br><br>
                    <button class="botaoAjuda" onclick="gerarResposta()">Perguntar</button>
                    <h3 style="margin-top: 20px;">Resposta da IA:</h3>
                    <div id="resposta"></div>
                </center>
            </div>
            <h1 class="titulo-ajuda"style="margin-top: 1%;">Baixar Manuais:</h1>
            <div class="botoes-download">
                
                <a style="text-decoration: none;" href="./assets/Manual de Instalação - Sensores.pdf" target="_blank" download>
                    <button class="botao-download" id="manualFisico">
                        <i class="fas fa-download"></i> Manual Físico
                    </button>
                </a>


                <a style="text-decoration: none;" href="./assets/Manual De Instalação - Software.pdf" target="_blank" download>
                    <button class="botao-download" id="manualLogico">
                        <i class="fas fa-download"></i> Manual Lógico
                    </button>
                </a>
            </div>
        </section>
    </main>

</body>

</html>

<script>
    // Substitua 'YOUR_API_KEY' pela sua chave de API da OpenWeatherMap
    const apiKey = 'c19433e50596af7f4bad734138dfeef4';
    const city = 'São Paulo'; // Substitua pela cidade desejada
    const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;

    // Dicionário de tradução para descrições do clima
    const weatherTranslations = {
        "clear sky": "Céu Limpo",
        "few clouds": "Poucas Nuvens",
        "scattered clouds": "Nuvens Dispersas",
        "broken clouds": "Nuvens Quebradas",
        "shower rain": "Chuva de Banho",
        "rain": "Chuva",
        "thunderstorm": "Trovoada",
        "snow": "Neve",
        "mist": "Névoa"
    };

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            console.log(data);
            const weatherDescription = data.weather[0].description;
            const translatedDescription = weatherTranslations[weatherDescription] || weatherDescription;

            const weatherDiv = document.getElementById('weather');
            clima.innerHTML = `
                <p style="font-size: 20px; font-weight:bold;">${data.name}:</p><br>
                <p style="font-size: 17px;">${translatedDescription}</p><br>

                <p style="font-size: 17px;">Temperatura: ${Math.round(data.main.temp)}°C</p><br>
                
                <p style="font-size: 17px;">Umidade: ${data.main.humidity}%</p>
            `;
        })
        .catch(error => {
            console.error('Erro ao buscar os dados climáticos:', error);
        });
</script>

<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.4.0/dist/justgage.min.js"></script>

<script>
    var gauge = new JustGage({
        id: "gauge",
        value: 50,
        min: 0,
        max: 100,
        levelColors: [
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff1000",
            "#ff0000",
            "#ffc000",
            "#def233",
            "#00ff00",
            "#bef233",
            "#ffa000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000"
        ],
        pointer: true
    });
</script>
<style>
    .custom-value {
            font-size: 44px !important; /* Aumente o tamanho da fonte aqui */
        }
</style>

<script>
    var gauge2 = new JustGage({
        id: "gauge2",
        value: 50,
        min: 0,
        max: 100,
        levelColors: [
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#fff000",
            "#a0f000",
            "#00ff00",
            "#fff000",
            "#ffa000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000",
            "#ff0000"
        ],
        pointer: true
    });

    setInterval(function () {
        gauge.refresh(umidadeAtualW[umidadeAtualW.length - 1]);
    }, 1000);

    setInterval(function () {
        gauge2.refresh(temperaturaAtualW[temperaturaAtualW.length - 1]);
    }, 1000);
</script>

<script src="js/script.js"></script>
<script src="js/trocarsecao.js"></script>
<script src="js/sessao.js"></script>

<script>
    /* ---------------------------------------------------- AREA GRAFICOS ----------------------------------------------------*/

    function scrollToSection(sectionId, lote) {
        // Encontra a seção pelo ID fornecido
        var section = document.getElementById(sectionId);

        // Define a propriedade display para 'block'
        section.style.display = 'block';
        section_areaDoUsuario.style.display = 'none';

        if (section == 'section_areaDoUsuario') {
            section.style.display = 'block';
            section_temperatura.style.display = 'none';
            section_umidade.style.display = 'none';

        }
        // Atualiza o texto da seção
        document.getElementById('setor').innerHTML = lote;
        document.getElementById('setor1').innerHTML = lote;

        // Rola até a seção
        section.scrollIntoView({ behavior: 'smooth' });
    }

    /* ---------------------------------------------------- CAPTURA DOS DADOS ----------------------------------------------------*/

    var umidadeAtualW = [];
    var temperaturaAtualW = []
    var horario = [];
    var maxDataPoints = 5; // Número máximo de pontos a serem exibidos no gráfico

    function captura() {
        fetch("/medidas/captura")
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error('Houve um erro na API!');
                }
            })
            .then(function (resposta) {
                console.log("Dados recebidos: ", JSON.stringify(resposta));

                // Adiciona os novos dados de umidade, temperatura e horário
                umidadeAtualW.push(parseFloat(resposta.umidade));
                temperaturaAtualW.push(parseFloat(resposta.temperatura));
                horario.push(resposta.horario);

                // Mantém apenas os últimos maxDataPoints pontos
                if (umidadeAtualW.length > maxDataPoints) {
                    umidadeAtualW.shift();
                    temperaturaAtualW.shift();
                    horario.shift();
                }


                // Atualiza os dados dos gráficos
                updateChartData();
                updateChartData1();
            })
            .catch(function (erro) {
                console.error(erro);
            });
    }


    // Criação do gráfico
    var contextoDht11Umidade = document.getElementById('dht11Umidade').getContext('2d');
    contextoDht11Umidade.canvas.width = 450;
    contextoDht11Umidade.canvas.height = 150;
    var dht11Umidade = new Chart(contextoDht11Umidade, {
        type: 'line',
        data: {
            labels: horario,
            datasets: [{
                data: umidadeAtualW,
                label: 'Umidade (%)',
                borderColor: '#008080',
                backgroundColor: 'rgba(0,255,255, 0.4)',
                borderWidth: 2
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontColor: 'black',
                        fontStyle: '800'
                    }
                }],
                xAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontColor: 'black',
                        fontStyle: '800'
                    }
                }]
            },
            legend: {
                labels: {
                    fontColor: 'black',
                    fontStyle: '800'
                }
            }
        }
    });

    function updateChartData() {
        // Atualiza os dados do gráfico
        dht11Umidade.data.labels = horario.slice(-maxDataPoints);
        dht11Umidade.data.datasets[0].data = umidadeAtualW.slice(-maxDataPoints);

        // Atualiza o gráfico
        dht11Umidade.update();

        let valorAtualUmidade = umidadeAtualW[umidadeAtualW.length - 1];

        if (valorAtualUmidade > 70) {
            // Atualiza o conteúdo e o estilo da div de texto para exibir o alerta
            document.getElementById('textboxUmi').innerHTML = '<img width="70px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt=""> <b>Alerta: Umidade muito acima de 60%!</b>';
            document.getElementById('textboxUmi').style.backgroundColor = 'red';
            document.getElementById('textboxUmi').style.color = 'white';
            document.getElementById('textboxUmi').style.border = '1px solid black';
            document.getElementById('iconUmi1').style.color = '#00ff00';
            document.getElementById('iconUmi2').style.color = 'yellow';
            document.getElementById('iconUmi3').style.color = 'red';
            document.getElementById('iconUmi4').style.color = 'yellow';

        } else if (valorAtualUmidade >= 65 && valorAtualUmidade <= 70) {
            document.getElementById('textboxUmi').innerHTML = '<img width="70px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt=""> <b>Cuidado: Umidade pouco acima de 60%!</b>';
            document.getElementById('textboxUmi').style.backgroundColor = 'yellow';
            document.getElementById('textboxUmi').style.color = 'black';
            document.getElementById('textboxUmi').style.border = '1px solid black';
            document.getElementById('iconUmi1').style.color = 'yellow';
            document.getElementById('iconUmi2').style.color = '#00ff00';
            document.getElementById('iconUmi3').style.color = 'yellow';
            document.getElementById('iconUmi4').style.color = 'red';
        }
        else if (valorAtualUmidade >= 49 && valorAtualUmidade <= 55) {
            document.getElementById('textboxUmi').innerHTML = '<img width="70px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt=""> <b>Cuidado: Umidade pouco abaixo de 60%!</b>';
            document.getElementById('textboxUmi').style.backgroundColor = 'yellow';
            document.getElementById('textboxUmi').style.color = 'black';
            document.getElementById('textboxUmi').style.border = '1px solid black';
            document.getElementById('iconUmi1').style.color = 'red';
            document.getElementById('iconUmi2').style.color = 'yellow';
            document.getElementById('iconUmi3').style.color = 'yellow';
            document.getElementById('iconUmi4').style.color = '#00ff00';
        }
        else if (valorAtualUmidade < 49) {
            document.getElementById('textboxUmi').innerHTML = '<img width="70px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt=""> <b>Alerta: Umidade muito abaixo de 60%!</b>';
            document.getElementById('textboxUmi').style.backgroundColor = 'red';
            document.getElementById('textboxUmi').style.color = 'white';
            document.getElementById('textboxUmi').style.border = '1px solid black';
            document.getElementById('iconUmi1').style.color = 'yellow';
            document.getElementById('iconUmi2').style.color = 'red';
            document.getElementById('iconUmi3').style.color = '#00ff00';
            document.getElementById('iconUmi4').style.color = 'red';
        } else {
            // Caso a temperatura não esteja acima de 35°C, limpa o conteúdo e o estilo da div de texto
            document.getElementById('textboxUmi').innerHTML = ' <img width="70px" src="./assets/favoravel.png"> <b>Tudo Sob-Controle Algodões Protegidos</b>';
            document.getElementById('textboxUmi').style.backgroundColor = '#00ff00';
            document.getElementById('textboxUmi').style.color = 'black';
            document.getElementById('textboxUmi').style.border = '1px solid black';
        }

    }

    // Inicia a captura de dados
    setInterval(captura, 5000);




    /* ------- LM35TEMPERATURA ------- */

    // Criação do gráfico
    var contextoLm35Temperatura = document.getElementById('lm35Temperatura').getContext('2d');
    contextoLm35Temperatura.canvas.width = 450;
    contextoLm35Temperatura.canvas.height = 150;
    var lm35Temperatura = new Chart(contextoLm35Temperatura, {
        type: 'line',
        data: {
            labels: horario,
            datasets: [{
                data: temperaturaAtualW,
                label: 'Temperatura (°C)',
                type: 'line',
                borderColor: ['#ff0000'],
                backgroundColor: 'rgba(255,99,71,0.6)',
                borderWidth: 2
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontColor: 'black',
                        fontStyle: '800'
                    }
                }],
                xAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontColor: 'black',
                        fontStyle: '800'
                    }
                }]
            },
            legend: {
                labels: {
                    fontColor: 'black',
                    fontStyle: '800'
                }
            }
        }
    });

    function updateChartData1() {

        lm35Temperatura.data.labels = horario.slice(-maxDataPoints);
        lm35Temperatura.data.datasets[0].data = temperaturaAtualW.slice(-maxDataPoints);

        // Atualiza o gráfico
        lm35Temperatura.update();

        if (temperaturaAtualW[temperaturaAtualW.length - 1] > 34) {
            // Atualiza o conteúdo e o estilo da div de texto para exibir o alerta
            document.getElementById('textboxTemp').innerHTML = '<img width="70px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt=""> <b>Alerta: Temperatura acima de 34°C!</b>';
            document.getElementById('textboxTemp').style.backgroundColor = 'red';
            document.getElementById('textboxTemp').style.color = 'white';
            document.getElementById('textboxTemp').style.border = '1px solid black';
            document.getElementById('iconTemp1').style.color = 'red';
            document.getElementById('iconTemp2').style.color = 'yellow';
            document.getElementById('iconTemp3').style.color = '#00ff00';
            document.getElementById('iconTemp4').style.color = 'yellow';

        } else if (temperaturaAtualW[temperaturaAtualW.length - 1] >= 30 && temperaturaAtualW[temperaturaAtualW.length - 1] <= 34) {
            document.getElementById('textboxTemp').innerHTML = '<img width="70px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt=""> <b>Cuidado: Temperatura próxima a 34°C!</b>';
            document.getElementById('textboxTemp').style.backgroundColor = 'yellow';
            document.getElementById('textboxTemp').style.color = 'black';
            document.getElementById('textboxTemp').style.border = '1px solid black';
            document.getElementById('iconTemp1').style.color = 'yellow';
            document.getElementById('iconTemp2').style.color = 'red';
            document.getElementById('iconTemp3').style.color = 'yellow';
            document.getElementById('iconTemp4').style.color = '#00ff00';
        }
        else if (temperaturaAtualW[temperaturaAtualW.length - 1] >= 16 && temperaturaAtualW[temperaturaAtualW.length - 1] <= 20) {
            document.getElementById('textboxTemp').innerHTML = '<img width="70px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt=""> <b>Cuidado: Temperatura próxima a 16°C!</b>';
            document.getElementById('textboxTemp').style.backgroundColor = 'yellow';
            document.getElementById('textboxTemp').style.color = 'black';
            document.getElementById('textboxTemp').style.border = '1px solid black';
            document.getElementById('iconTemp1').style.color = '#00ff00';
            document.getElementById('iconTemp2').style.color = 'yellow';
            document.getElementById('iconTemp3').style.color = 'red';
            document.getElementById('iconTemp4').style.color = 'yellow';
        }
        else if (temperaturaAtualW[temperaturaAtualW.length - 1] < 16) {
            document.getElementById('textboxTemp').innerHTML = '<img width="70px" src="https://cdn-icons-png.flaticon.com/512/272/272340.png" alt=""> <b>Alerta: Temperatura abaixo de 16°C!</b>';
            document.getElementById('textboxTemp').style.backgroundColor = 'red';
            document.getElementById('textboxTemp').style.color = 'white';
            document.getElementById('textboxTemp').style.border = '1px solid black';
            document.getElementById('iconTemp1').style.color = 'yellow';
            document.getElementById('iconTemp2').style.color = '#00ff00';
            document.getElementById('iconTemp3').style.color = 'yellow';
            document.getElementById('iconTemp4').style.color = 'red';
        } else if (temperaturaAtualW[temperaturaAtualW.length - 1] >= 21 && temperaturaAtualW[temperaturaAtualW.length - 1] <= 29) {
            document.getElementById('textboxTemp').innerHTML = ' <img width="70px" src="./assets/favoravel.png"> <b>Tudo Sob-Controle Algodões Protegidos</b>';
            document.getElementById('textboxTemp').style.backgroundColor = '#00ff00';
            document.getElementById('textboxTemp').style.color = 'black';
            document.getElementById('textboxTemp').style.border = '1px solid black';
            document.getElementById('iconTemp1').style.color = 'yellow';
            document.getElementById('iconTemp2').style.color = '#00ff00';
            document.getElementById('iconTemp3').style.color = 'yellow';
            document.getElementById('iconTemp4').style.color = 'red';
        }
    }


    // Verifica se a temperatura ultrapassou 35°C



    // // Chamada inicial da função para garantir que os dados sejam atualizados assim que a página for carregada
    updateChartData1();
    captura();


    /* ---------------------------------------------------- DATA E HORARIO ATUAL ----------------------------------------------------*/

    function getFormattedDateTime() {
        var now = new Date();
        var formattedDateTime = now.toLocaleString(); // Obtém a data e hora atual no formato local
        return formattedDateTime;
    }

    // Chamada da função para atualizar os dados a cada intervalo de tempo (por exemplo, a cada cinco segundos)
    setInterval(updateChartData1, 5000); // 5000ms = 5 segundos

    function updateDateTime() {
        var now = new Date();
        var datetimeElement = document.getElementById('tempo');
        datetimeElement.innerHTML = `<span style="font-size: 20px; font-weight:bold">Data e Hora:</span><br> 
        <span style="font-size: 22px;">${now.toLocaleString()}</span><br><span style="font-weight:bold; font-size: 18px;">Horário de Brasília</span>`; // Exibe a data e hora no formato local
    }

    // Chama inicialmente a função para exibir a data e hora atual
    updateDateTime();

    // Chama a função a cada segundo para manter a data e hora atualizada
    setInterval(updateDateTime, 1000); // 1000ms = 1 segundo


    /* ----------------------------------------------------     TABELAS ----------------------------------------------------*/



 // Função para adicionar uma nova linha à tabela com os últimos dados
function adicionarLinhaTabela(dataHora, temperatura, umidade, lote) {
  var tabela = document.getElementById('dadosTabela').getElementsByTagName('tbody')[0];
  var numeroLinhas = tabela.rows.length;

  // Se o número de linhas for igual a 15, remove a última linha antes de adicionar uma nova
  if (numeroLinhas === 15) {
    tabela.deleteRow(numeroLinhas - 1); // Remove a última linha
  }

  var novaLinha = tabela.insertRow(0);
  var novaCelulaDataHora = novaLinha.insertCell(0);
  var novaCelulaTemperatura = novaLinha.insertCell(1);
  var novaCelulaUmidade = novaLinha.insertCell(2);
  var novaCelulaLote = novaLinha.insertCell(3); // Nova célula para o campo de Lote
  novaCelulaDataHora.innerHTML = dataHora;
  novaCelulaTemperatura.innerHTML = temperatura;
  novaCelulaUmidade.innerHTML = umidade;
  novaCelulaLote.innerHTML = lote; // Define o valor do campo de lote
}

// Função para atualizar os dados da tabela com os últimos dados de temperatura e umidade
function atualizarTabela() {
  // Obtém os últimos dados de temperatura e umidade dos gráficos
  var umidadeAtual = dht11Umidade.data.datasets[0].data[dht11Umidade.data.datasets[0].data.length - 1];
  var temperaturaAtual = lm35Temperatura.data.datasets[0].data[lm35Temperatura.data.datasets[0].data.length - 1];
  var lote = Math.floor(Math.random() * 4) + 1;
  // Obtém a data e hora atuais
  var dataHoraAtual = new Date().toLocaleString();

  if (loteEspecifico.value == "1") {
    lote = "1";
  } else if (loteEspecifico.value == "2") {
    lote = "2";
  } else if (loteEspecifico.value == "3") {
    lote = "3";
  } else if (loteEspecifico.value == "4") {
    lote = "4";
  } else {
    lote = Math.floor(Math.random() * 4) + 1;
  }

  // Adiciona uma nova linha à tabela com os últimos dados
  adicionarLinhaTabela(dataHoraAtual, temperaturaAtual + "°C", umidadeAtual + "%", "Lote " + lote);

  // Atualiza o intervaloSelecionado com base no valor do dropdown
  var intervaloSelecionado = 3000;
  if (intervaloEspecifico.value == 5) {
    intervaloSelecionado = 5000;
  } else if (intervaloEspecifico.value == 10) {
    intervaloSelecionado = 10000;
  } else if (intervaloEspecifico.value == 15) {
    intervaloSelecionado = 15000;
  } else if (intervaloEspecifico.value == 30) {
    intervaloSelecionado = 30000;
  } else if (intervaloEspecifico.value == 60) {
    intervaloSelecionado = 60000;
  }

  // Limpa o intervalo anterior e define um novo com o intervalo selecionado
  clearInterval(intervaloAtualizacao);
  intervaloAtualizacao = setInterval(atualizarTabela, intervaloSelecionado);
}

// Variável para armazenar o intervalo
var intervaloAtualizacao;

// Define o intervalo inicial de atualização
var intervaloSelecionado = 3000;

// Inicia a atualização da tabela a cada 3 segundos
setTimeout(atualizarTabela, 1000);

// Atualiza o intervalo quando o valor do dropdown muda
intervaloEspecifico.onchange = function() {
  atualizarTabela();
};

    function exportar() {
        // Seleciona a tabela HTML
        var tabela = document.getElementById("dadosTabela"); //Pega o id da table html

        // Cria um objeto Excel
        var excel = new ExcelJS.Workbook();
        var sheet = excel.addWorksheet("Fazenda Karpos"); // Nome da folha da planilha


        // Itera sobre as linhas e colunas da tabela HTML e adiciona os dados à planilha Excel
        var rows = tabela.rows;
        for (var i = 0; i < rows.length; i++) {
            var row = sheet.getRow(i + 1); // Adiciona 1 porque o índice do Excel começa em 1
            var cells = rows[i].cells;
            for (var j = 0; j < cells.length; j++) {
                row.getCell(j + 1).value = cells[j].innerText; // Adiciona 1 porque o índice do Excel começa em 1
            }
        }

        sheet.getRow(1).eachCell(function (cell) { // Pega a row 1 = Linha 1
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF263238' } // Acrescenta a cor desejada
            };
            cell.font = { color: { argb: "FFFFFFFF" } };
        });

        sheet.columns.forEach(column => {
            column.width = 29; // Define a largura desejada em caracteres
        });

        // Cria um objeto Blob para salvar o arquivo Excel
        excel.xlsx.writeBuffer().then(function (buffer) {
            var blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            var url = window.URL.createObjectURL(blob);

            // Cria um link para download do arquivo Excel
            var a = document.createElement("a");
            a.href = url;
            a.download = "FazendaKarpos.xlsx"; //Nome do Arquivo
            a.click();
        });
    }

    // fazer a chamada do BobIA
    async function gerarResposta() {
        const pergunta = document.getElementById('pergunta').value;

        const response = await fetch('http://localhost:8080/perguntar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ pergunta })
        });

        const data = await response.json();

        resposta.style.display = 'block';
        document.getElementById('resposta').innerText = data.resultado;
    }
</script>
<script src="main.js"></script>